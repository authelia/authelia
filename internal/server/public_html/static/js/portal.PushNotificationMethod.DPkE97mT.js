import{u as F,m as A,r as o,g as B,h as U,A as E,j as l,B as C}from"./index.BAKKlMLi.js";import{F as M}from"./components.FailureIcon.BpO80mgg.js";import{P as H}from"./components.PushNotificationIcon.Cd8rzblv.js";import{S as O}from"./components.SuccessIcon.C6YNXyF1.js";import{j as Y,B as q}from"./constants.constants.Dc-vougk.js";import{u as G}from"./hooks.Mounted.Bo5u1Dd8.js";import{u as Q}from"./hooks.OpenIDConnect.g4Kxe8nK.js";import{i as $,c as z,a as J,D as K}from"./portal.DeviceSelectionContainer.Biq8Y0na.js";import{D as V,S as v}from"./portal.MethodContainer.DXr9-HkP.js";import"./components.InformationIcon.CdJt0GDn.js";import"./portal.Authenticated.CBKE-Fj7.js";var W=(e=>(e[e.SignInInProgress=1]="SignInInProgress",e[e.Success=2]="Success",e[e.Failure=3]="Failure",e[e.Selection=4]="Selection",e[e.Enroll=5]="Enroll",e[e.RateLimited=6]="RateLimited",e))(W||{});const ue=function(e){const{t:n}=F(),{classes:L}=X(),{id:D,flow:b,subflow:S}=Y(),y=Q(),[a,r]=o.useState(1),k=B(U),s=G(),[g,T]=o.useState(""),[j,I]=o.useState([]),{onSignInSuccess:p,onSignInError:N}=e,i=o.useRef(N).current,m=o.useRef(p).current,c=o.useRef(null);o.useEffect(()=>()=>{c.current!==null&&(clearTimeout(c.current),c.current=null)},[]);const R=o.useCallback(t=>{c.current&&clearTimeout(c.current),r(6),i(new Error(n("You have made too many requests"))),c.current=setTimeout(()=>{if(!s.current){c.current=null;return}r(3),c.current=null},t*1e3)},[s,i,n]),P=o.useCallback(async()=>{try{const t=await $();if(!s.current)return;switch(t.result){case"auth":let u=[];t.devices.forEach(d=>u.push({id:d.device,name:d.display_name,methods:d.capabilities})),I(u),r(4);break;case"allow":i(new Error(n("Device selection was bypassed by Duo policy"))),r(2);break;case"deny":i(new Error(n("Device selection was denied by Duo policy"))),r(3);break;case"enroll":i(new Error(n("No compatible device found"))),t.enroll_url&&e.duoSelfEnrollment&&T(t.enroll_url),r(5);break}}catch(t){if(!s.current)return;console.error(t),i(new Error(n("There was an issue fetching Duo device(s)")))}},[e.duoSelfEnrollment,s,i,n]),h=o.useCallback(async()=>{if(e.authenticationLevel!==E.TwoFactor)try{r(1);const t=await z(k,D,b,S,y);if(!s.current)return;if(t)if(t.data&&!t.limited)switch(t.data.result){case"auth":let u=[];t.data.devices.forEach(d=>u.push({id:d.device,name:d.display_name,methods:d.capabilities})),I(u),r(4);break;case"enroll":i(new Error(n("No compatible device found"))),t.data.enroll_url&&e.duoSelfEnrollment&&T(t.data.enroll_url),r(5);break;case"deny":i(new Error(n("Device selection was denied by Duo policy"))),r(3);break;default:r(2),setTimeout(()=>{s.current&&m(t.data?t.data.redirect:void 0)},1500)}else t.limited?R(t.retryAfter):(r(2),setTimeout(()=>{s.current&&m(t.data?t.data.redirect:void 0)},1500));else i(new Error(n("There was an issue completing sign in process"))),r(3)}catch(t){if(!s.current||a!==1)return;console.error(t),i(new Error(n("There was an issue completing sign in process"))),r(3)}},[e.authenticationLevel,e.duoSelfEnrollment,k,D,b,S,y,s,i,n,m,R,a]),x=o.useCallback(async function(t){try{await J(t),e.registered?r(1):(r(1),e.onSelectionClick())}catch(u){console.error(u),i(new Error(n("There was an issue updating preferred Duo device")))}},[i,e,n]),_=o.useCallback(t=>{x({device:t.id,method:t.method})},[x]);if(o.useEffect(()=>{e.authenticationLevel>=E.TwoFactor&&r(2)},[e.authenticationLevel,r]),o.useEffect(()=>{a===1&&h()},[h,a]),a===4)return l.jsx(K,{devices:j,onBack:()=>r(1),onSelect:_});let f;switch(a){case 1:f=l.jsx(H,{width:64,height:64,animated:!0});break;case 2:f=l.jsx(O,{});break;case 3:f=l.jsx(M,{})}let w=v.METHOD;return e.authenticationLevel===E.TwoFactor?w=v.ALREADY_AUTHENTICATED:a===5&&(w=v.NOT_REGISTERED),l.jsxs(V,{id:e.id,title:n("Push Notification"),explanation:n("A notification has been sent to your smartphone"),duoSelfEnrollment:g?e.duoSelfEnrollment:!1,registered:e.registered,state:w,onSelectClick:P,onRegisterClick:()=>window.open(g,"_blank"),children:[l.jsx(C,{className:L.icon,children:f}),l.jsx(C,{className:a!==3?"hidden":"",children:l.jsx(q,{color:"secondary",onClick:h,children:n("Retry")})})]})},X=A()(e=>({icon:{width:"64px",height:"64px",display:"inline-block"}}));export{W as State,ue as default};
