import{u as b,g as k,h as I,r as a,A as R,j as T}from"./index.Cnoc1xvA.js";import{W as F}from"./components.WebAuthnTryIcon.Ie24j3zY.js";import{j as C}from"./constants.constants.C7XWv2Yg.js";import{u as W}from"./hooks.Mounted.zqJHXAmG.js";import{u as x}from"./hooks.OpenIDConnect.DIXavwCS.js";import{W as n,j,e as D,h as L,i as v,k as M}from"./services.WebAuthn.ssE5ERIK.js";import{D as O,S as f}from"./portal.MethodContainer.BjdCDRHJ.js";import"./components.FailureIcon.CJF-1aOx.js";import"./components.SuccessIcon.DhmnFkmE.js";import"./components.TimerIcon.7hnoDN64.js";import"./hooks.Timer.Cnyqth1t.js";import"./portal.IconWithContext.DucLu93y.js";import"./browserSupportsWebAuthn.Bhlk1eaM.js";import"./components.InformationIcon.DesXiPIb.js";import"./portal.Authenticated.DmyQJIWb.js";const Z=function(e){const{t}=b(),h=k(I),{id:m,flow:S,subflow:g}=C(),E=x(),r=W(),[y,s]=a.useState(n.WaitTouch),{onSignInSuccess:p,onSignInError:A}=e,o=a.useRef(A).current,w=a.useRef(p).current,l=a.useCallback(async()=>{if(!(!e.registered||e.authenticationLevel===R.TwoFactor))try{s(n.WaitTouch);const i=await j();if(!r.current)return;if(i.status!==200||i.options==null){s(n.Failure),o(new Error(t("Failed to initiate security key sign in process")));return}const u=await D(i.options);if(u.result!==L.Success){if(!r.current)return;s(n.Failure),o(new Error(t(v(u.result))));return}if(u.response==null){if(!r.current)return;o(new Error(t("The browser did not respond with the expected attestation data"))),s(n.Failure);return}if(!r.current)return;s(n.InProgress);const c=await M(u.response,h,m,S,g,E);if(c.data.status==="OK"&&c.status===200){if(!r.current)return;w(c.data.data?c.data.data.redirect:void 0);return}if(!r.current)return;o(new Error(t("The server rejected the security key"))),s(n.Failure)}catch(i){if(!r.current)return;console.error(i),o(new Error(t("Failed to initiate security key sign in process"))),s(n.Failure)}},[e.registered,e.authenticationLevel,r,h,m,S,g,E,o,t,w]);a.useEffect(()=>{l().catch(console.error)},[l]);let d=f.METHOD;return e.authenticationLevel===R.TwoFactor?d=f.ALREADY_AUTHENTICATED:e.registered||(d=f.NOT_REGISTERED),T.jsx(O,{id:e.id,title:t("Security Key"),explanation:t("Touch the token of your security key"),duoSelfEnrollment:!1,registered:e.registered,state:d,onRegisterClick:e.onRegisterClick,children:T.jsx(F,{onRetryClick:l,webauthnTouchState:y})})};export{Z as default};
