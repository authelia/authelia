import{j as e,U as re,u as K,g as E,h as B,aB as W,r as n,G as u,T as ae,q as N,m as oe,p as ie,c as le,aC as ce,aD as ue,t as de,ak as fe,aE as he}from"./index.BnjZL0N4.js";import{I as me,V as we,a as ge,A as xe}from"./mui.VisibilityOff.BUHw9Zaa.js";import{j as Z,a as pe,B as G,h as be}from"./constants.constants.B5-HX_Wn.js";import{u as ye}from"./hooks.OpenIDConnect.BaEMeLF5.js";import{L as ke}from"./layouts.Login.VG_BrWNm.js";import{p as Ce,I as Se}from"./services.Password.BsZ6YsrN.js";import{u as je}from"./hooks.Mounted.CdqvZepY.js";import{c as Re,e as ve,h as Pe,i as Ae,p as Te}from"./services.WebAuthn.GTWF5sXw.js";import{B as Ee,C as Le}from"./broadcast-channel.fVXyNXey.js";import{F as Me,T as z}from"./mui.TextField.CvNqVYgs.js";import{F as qe}from"./mui.FormControlLabel.DvFC4aiQ.js";import"./layouts.usePortalStyles.DCcToFh4.js";import"./browserSupportsWebAuthn.Bhlk1eaM.js";const Fe=function(){return e.jsx(re,{children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",height:24,width:24,viewBox:"0 -960 960 960",fill:"#e8eaed",children:e.jsx("path",{d:"M120-160v-112q0-34 17.5-62.5T184-378q62-31 126-46.5T440-440q20 0 40 1.5t40 4.5q-4 58 21 109.5t73 84.5v80H120ZM760-40l-60-60v-186q-44-13-72-49.5T600-420q0-58 41-99t99-41q58 0 99 41t41 99q0 45-25.5 80T790-290l50 50-60 60 60 60-80 80ZM440-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm300 80q17 0 28.5-11.5T780-440q0-17-11.5-28.5T740-480q-17 0-28.5 11.5T700-440q0 17 11.5 28.5T740-400Z"})})})},Ie=function(t){const{t:r}=K(),d=E(B),C=E(W),{id:R,flow:x,subflow:S}=Z(),l=je(),[p,j]=n.useState(!1),c=n.useRef(t.onAuthenticationError).current,b=n.useCallback(()=>{t.onAuthenticationStart(),j(!0)},[t]),i=n.useCallback(()=>{t.onAuthenticationStop(),j(!1)},[t]),y=n.useCallback(async()=>{if(!(!l||p)){b();try{const m=await Re();if(m.status!==200||m.options==null){i(),c(new Error(r("Failed to initiate security key sign in process")));return}const a=await ve(m.options);if(a.result!==Pe.Success){if(!l.current)return;i(),c(new Error(r(Ae(a.result))));return}if(a.response==null){c(new Error(r("The browser did not respond with the expected attestation data"))),i();return}if(!l.current)return;const w=await Te(a.response,t.rememberMe,d,C,R,x,S);if(i(),w.data.status==="OK"&&w.status===200){t.onAuthenticationSuccess(w.data.data?w.data.data.redirect:void 0);return}if(!l.current)return;c(new Error(r("The server rejected the security key")))}catch(m){if(i(),!l.current)return;console.error(m),c(new Error(r("Failed to initiate security key sign in process")))}}},[l,p,b,t,d,C,R,x,S,i,c,r]);return e.jsxs(n.Fragment,{children:[e.jsx(u,{size:{xs:12},children:e.jsx(pe,{component:"div",role:"presentation",children:e.jsx(ae,{sx:{textTransform:"uppercase"},children:r("or")})})}),e.jsx(u,{size:{xs:12},children:e.jsx(G,{id:"passkey-sign-in-button",variant:"contained",color:"primary",fullWidth:!0,onClick:y,startIcon:e.jsx(Fe,{}),disabled:t.disabled,endIcon:p?e.jsx(N,{size:20}):null,children:r("Sign in with a passkey")})})]})},Je=function(t){const{t:r}=K(),{classes:d,cx:C}=De(),R=ie(),x=E(B),S=E(W),{id:l,flow:p,subflow:j}=Z(),c=ye(),{createErrorNotification:b}=le(),i=n.useMemo(()=>new Ee("login"),[]),[y,m]=n.useState(!1),[a,w]=n.useState(""),[H,v]=n.useState(!1),[o,L]=n.useState(""),[q,f]=n.useState(!1),[O,F]=n.useState(!1),[V,I]=n.useState(!1),[Q,D]=n.useState(!1),[X,M]=n.useState(!1),P=n.useRef(null),A=n.useRef(null),k=n.useCallback(()=>{P.current!==null&&P.current.focus()},[P]),h=n.useCallback(()=>{A.current!==null&&A.current.focus()},[A]);n.useEffect(()=>{const s=setTimeout(()=>k(),10);return()=>clearTimeout(s)},[k]),n.useEffect(()=>{i.addEventListener("message",s=>{s&&t.onChannelStateChange()})},[i,x,t]);const T=t.disabled,J=ce(),Y=ue(),_=()=>{m(!y)},g=n.useCallback(async()=>{if(a===""||o===""){a===""&&v(!0),o===""&&D(!0);return}M(!0),t.onAuthenticationStart();try{const s=await Ce(a,o,y,x,S,l,p,j,c);M(!1),await i.postMessage(!0),t.onAuthenticationSuccess(s?s.redirect:void 0)}catch(s){console.error(s),b(r("Incorrect username or password")),M(!1),t.onAuthenticationStop(),L(""),h()}},[a,o,t,y,x,S,l,p,j,c,i,b,r,h]),$=()=>{t.resetPassword&&(t.resetPasswordCustomURL!==""?window.open(t.resetPasswordCustomURL):R(he))},ee=n.useCallback(s=>{s.key==="Enter"&&(a.length?a.length&&o.length?g().catch(console.error):(v(!1),h()):v(!0))},[h,g,o.length,a.length]),te=n.useCallback(s=>{s.key==="Enter"&&(a.length?o.length||h():k(),g().catch(console.error),s.preventDefault())},[h,k,g,o.length,a.length]),se=n.useCallback(s=>{if(o.length<=1&&(F(!1),I(!1),o.length===0))return;const U=Se(s);U!==null&&(U?F(!0):I(!0))},[o.length]),ne=n.useCallback(s=>{s.key==="Enter"&&(a.length?o.length||h():k(),g().catch(console.error))},[h,k,g,o.length,a.length]);return e.jsx(ke,{id:"first-factor-stage",title:J,subtitle:Y,children:e.jsx(Me,{id:"form-login",children:e.jsxs(u,{container:!0,spacing:2,children:[e.jsx(u,{size:{xs:12},children:e.jsx(z,{inputRef:P,id:"username-textfield",label:r("Username"),variant:"outlined",required:!0,value:a,error:H,disabled:T,fullWidth:!0,onChange:s=>w(s.target.value),onFocus:()=>v(!1),autoCapitalize:"none",autoComplete:"username",onKeyDown:ee})}),e.jsx(u,{size:{xs:12},children:e.jsx(z,{inputRef:A,id:"password-textfield",label:r("Password"),variant:"outlined",required:!0,fullWidth:!0,disabled:T,value:o,error:Q,onChange:s=>L(s.target.value),onFocus:()=>D(!1),type:q?"text":"password",autoComplete:"current-password",onKeyDown:te,onKeyUp:se,slotProps:{input:{endAdornment:e.jsx(me,{position:"end",children:e.jsx(de,{"aria-label":"toggle password visibility",edge:"end",size:"large",onMouseDown:()=>f(!0),onMouseUp:()=>f(!1),onMouseLeave:()=>f(!1),onTouchStart:()=>f(!0),onTouchEnd:()=>f(!1),onTouchCancel:()=>f(!1),onKeyDown:s=>{s.key===" "&&(f(!0),s.preventDefault())},onKeyUp:s=>{s.key===" "&&(f(!1),s.preventDefault())},children:q?e.jsx(we,{}):e.jsx(ge,{})})})}}})}),O?e.jsx(u,{size:{xs:12},marginX:2,children:e.jsxs(fe,{severity:"warning",children:[e.jsx(xe,{children:r("Warning")}),r(V?"The password was partially entered with Caps Lock":"The password was entered with Caps Lock")]})}):null,t.rememberMe?e.jsx(u,{size:{xs:12},className:C(d.actionRow),children:e.jsx(qe,{control:e.jsx(Le,{id:"remember-checkbox",disabled:T,checked:y,onChange:_,onKeyDown:ne,value:"rememberMe",color:"primary"}),className:d.rememberMe,label:r("Remember me")})}):null,e.jsx(u,{size:{xs:12},children:e.jsx(G,{id:"sign-in-button",variant:"contained",color:"primary",fullWidth:!0,endIcon:X?e.jsx(N,{size:20}):null,disabled:T,onClick:g,children:r("Sign in")})}),t.passkeyLogin?e.jsx(Ie,{disabled:t.disabled,rememberMe:t.rememberMe,onAuthenticationError:s=>b(s.message),onAuthenticationStart:()=>{w(""),L(""),t.onAuthenticationStart()},onAuthenticationStop:t.onAuthenticationStop,onAuthenticationSuccess:t.onAuthenticationSuccess}):null,t.resetPassword?e.jsx(u,{size:{xs:12},className:C(d.actionRow,d.flexEnd),children:e.jsx(be,{id:"reset-password-button",component:"button",onClick:$,className:d.resetLink,underline:"hover",children:r("Reset password?")})}):null]})})})},De=oe()(t=>({actionRow:{display:"flex",flexDirection:"row",marginTop:t.spacing(-1),marginBottom:t.spacing(-1)},resetLink:{cursor:"pointer",paddingTop:13.5,paddingBottom:13.5},rememberMe:{flexGrow:1},flexEnd:{justifyContent:"flex-end"}}));export{Je as default};
