import{u as I,g as F,h as b,r as c,A as E,j as T}from"./index.J4YSomth.js";import{W as k}from"./components.WebAuthnTryIcon.D9srFnjZ.js";import{j as W}from"./constants.constants.BvDkw1BZ.js";import{u as x}from"./hooks.Mounted.CNeV72_h.js";import{u as C}from"./hooks.OpenIDConnect.fHo8fPKW.js";import{W as r,j,e as D,h as L,i as v,k as M}from"./services.WebAuthn.DEcKBZA4.js";import{D as O,S as f}from"./portal.MethodContainer.B7LucbyW.js";import"./components.FailureIcon.C8E_4zaM.js";import"./components.SuccessIcon.C3pLKly2.js";import"./components.TimerIcon.CO1b_Yfm.js";import"./hooks.Timer.Bev0y0Kd.js";import"./portal.IconWithContext.CCYYopkv.js";import"./browserSupportsWebAuthn.Bhlk1eaM.js";import"./components.InformationIcon.Hu39YtA5.js";import"./portal.Authenticated.KMDfbGon.js";const Z=function(e){const{t}=I(),h=F(b),{flow:m,id:y,subflow:p}=W(),R=C(),a=x(),S=(i,o)=>o.type,[A,s]=c.useReducer(S,r.WaitTouch),{onSignInError:n,onSignInSuccess:g}=e,w=c.useRef(!1),l=c.useCallback(async()=>{if(!(!e.registered||e.authenticationLevel===E.TwoFactor))try{s({type:r.WaitTouch});const i=await j();if(i.status!==200||i.options==null){s({type:r.Failure}),n(new Error(t("Failed to initiate security key sign in process")));return}const o=await D(i.options);if(o.result!==L.Success){if(!a.current)return;s({type:r.Failure}),n(new Error(t(v(o.result))));return}if(o.response==null){n(new Error(t("The browser did not respond with the expected attestation data"))),s({type:r.Failure});return}if(!a.current)return;s({type:r.InProgress});const u=await M(o.response,h,y,m,p,R);if(u.data.status==="OK"&&u.status===200){g(u.data.data?u.data.data.redirect:void 0);return}if(!a.current)return;n(new Error(t("The server rejected the security key"))),s({type:r.Failure})}catch(i){if(!a.current)return;console.error(i),n(new Error(t("Failed to initiate security key sign in process"))),s({type:r.Failure})}},[e.registered,e.authenticationLevel,a,h,y,m,p,R,n,t,g]);c.useEffect(()=>{w.current||(w.current=!0,l().catch(console.error))},[l]);let d=f.METHOD;return e.authenticationLevel===E.TwoFactor?d=f.ALREADY_AUTHENTICATED:e.registered||(d=f.NOT_REGISTERED),T.jsx(O,{id:e.id,title:t("Security Key"),explanation:t("Touch the token of your security key"),duoSelfEnrollment:!1,registered:e.registered,state:d,onRegisterClick:e.onRegisterClick,children:T.jsx(k,{onRetryClick:l,webauthnTouchState:A})})};export{Z as default};
