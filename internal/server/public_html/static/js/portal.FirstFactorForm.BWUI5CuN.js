import{j as e,U as se,u as K,g as E,h as B,aA as W,r as n,G as u,T as ne,q as N,m as re,p as oe,c as ae,t as ie,ak as le,aB as ce}from"./index.J4YSomth.js";import{I as ue,V as de,a as fe,A as he}from"./mui.VisibilityOff.BbFGBtcl.js";import{j as Z,a as me,B as G,h as we}from"./constants.constants.BvDkw1BZ.js";import{u as ge}from"./hooks.OpenIDConnect.fHo8fPKW.js";import{L as xe}from"./layouts.Login.CRKTUBU4.js";import{p as pe,I as be}from"./services.Password.B3E9NQ0q.js";import{u as ye}from"./hooks.Mounted.CNeV72_h.js";import{c as ke,e as Ce,h as Se,i as je,p as Re}from"./services.WebAuthn.DEcKBZA4.js";import{B as ve,C as Ae}from"./broadcast-channel.VqNLyvA6.js";import{F as Te,T as z}from"./mui.TextField.oVnBvIhZ.js";import{F as Pe}from"./mui.FormControlLabel.D2nRzGhM.js";import"./components.TypographyWithTooltip.DDFBjLT9.js";import"./browserSupportsWebAuthn.Bhlk1eaM.js";const Ee=function(){return e.jsx(se,{children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",height:24,width:24,viewBox:"0 -960 960 960",fill:"#e8eaed",children:e.jsx("path",{d:"M120-160v-112q0-34 17.5-62.5T184-378q62-31 126-46.5T440-440q20 0 40 1.5t40 4.5q-4 58 21 109.5t73 84.5v80H120ZM760-40l-60-60v-186q-44-13-72-49.5T600-420q0-58 41-99t99-41q58 0 99 41t41 99q0 45-25.5 80T790-290l50 50-60 60 60 60-80 80ZM440-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm300 80q17 0 28.5-11.5T780-440q0-17-11.5-28.5T740-480q-17 0-28.5 11.5T700-440q0 17 11.5 28.5T740-400Z"})})})},Le=function(t){const{t:r}=K(),d=E(B),C=E(W),{flow:R,id:x,subflow:S}=Z(),l=ye(),[p,j]=n.useState(!1),c=n.useRef(t.onAuthenticationError).current,b=n.useCallback(()=>{t.onAuthenticationStart(),j(!0)},[t]),i=n.useCallback(()=>{t.onAuthenticationStop(),j(!1)},[t]),y=n.useCallback(async()=>{if(!(!l||p)){b();try{const m=await ke();if(m.status!==200||m.options==null){i(),c(new Error(r("Failed to initiate security key sign in process")));return}const o=await Ce(m.options);if(o.result!==Se.Success){if(!l.current)return;i(),c(new Error(r(je(o.result))));return}if(o.response==null){c(new Error(r("The browser did not respond with the expected attestation data"))),i();return}if(!l.current)return;const w=await Re(o.response,t.rememberMe,d,C,x,R,S);if(i(),w.data.status==="OK"&&w.status===200){t.onAuthenticationSuccess(w.data.data?w.data.data.redirect:void 0);return}if(!l.current)return;c(new Error(r("The server rejected the security key")))}catch(m){if(i(),!l.current)return;console.error(m),c(new Error(r("Failed to initiate security key sign in process")))}}},[l,p,b,t,d,C,x,R,S,i,c,r]);return e.jsxs(n.Fragment,{children:[e.jsx(u,{size:{xs:12},children:e.jsx(me,{component:"div",children:e.jsx(ne,{sx:{textTransform:"uppercase"},children:r("or")})})}),e.jsx(u,{size:{xs:12},children:e.jsx(G,{id:"passkey-sign-in-button",variant:"contained",color:"primary",fullWidth:!0,onClick:y,startIcon:e.jsx(Ee,{}),disabled:t.disabled,endIcon:p?e.jsx(N,{size:20}):null,children:r("Sign in with a passkey")})})]})},Ve=function(t){const{t:r}=K(),{classes:d,cx:C}=Me(),R=oe(),x=E(B),S=E(W),{flow:l,id:p,subflow:j}=Z(),c=ge(),{createErrorNotification:b}=ae(),i=n.useMemo(()=>new ve("login"),[]),[y,m]=n.useState(!1),[o,w]=n.useState(""),[O,v]=n.useState(!1),[a,L]=n.useState(""),[q,f]=n.useState(!1),[V,F]=n.useState(!1),[H,I]=n.useState(!1),[Q,U]=n.useState(!1),[X,M]=n.useState(!1),A=n.useRef(null),T=n.useRef(null),k=n.useCallback(()=>{A.current!==null&&A.current.focus()},[A]),h=n.useCallback(()=>{T.current!==null&&T.current.focus()},[T]);n.useEffect(()=>{const s=setTimeout(()=>k(),10);return()=>clearTimeout(s)},[k]),n.useEffect(()=>{i.addEventListener("message",s=>{s&&t.onChannelStateChange()})},[i,x,t]);const P=t.disabled,J=()=>{m(!y)},g=n.useCallback(async()=>{if(o===""||a===""){o===""&&v(!0),a===""&&U(!0);return}M(!0),t.onAuthenticationStart();try{const s=await pe(o,a,y,x,S,p,l,j,c);M(!1),await i.postMessage(!0),t.onAuthenticationSuccess(s?s.redirect:void 0)}catch(s){console.error(s),b(r("Incorrect username or password")),M(!1),t.onAuthenticationStop(),L(""),h()}},[o,a,t,y,x,S,p,l,j,c,i,b,r,h]),Y=()=>{t.resetPassword&&(t.resetPasswordCustomURL?window.open(t.resetPasswordCustomURL):R(ce))},_=n.useCallback(s=>{s.key==="Enter"&&(o.length?o.length&&a.length?g().catch(console.error):(v(!1),h()):v(!0))},[h,g,a.length,o.length]),$=n.useCallback(s=>{s.key==="Enter"&&(o.length?a.length||h():k(),g().catch(console.error),s.preventDefault())},[h,k,g,a.length,o.length]),ee=n.useCallback(s=>{if(a.length<=1&&(F(!1),I(!1),a.length===0))return;const D=be(s);D!==null&&(D?F(!0):I(!0))},[a.length]),te=n.useCallback(s=>{s.key==="Enter"&&(o.length?a.length||h():k(),g().catch(console.error))},[h,k,g,a.length,o.length]);return e.jsx(xe,{id:"first-factor-stage",title:r("Sign in"),children:e.jsx(Te,{id:"form-login",children:e.jsxs(u,{container:!0,spacing:2,children:[e.jsx(u,{size:{xs:12},children:e.jsx(z,{inputRef:A,id:"username-textfield",label:r("Username"),variant:"outlined",required:!0,value:o,error:O,disabled:P,fullWidth:!0,onChange:s=>w(s.target.value),onFocus:()=>v(!1),autoCapitalize:"none",autoComplete:"username",onKeyDown:_})}),e.jsx(u,{size:{xs:12},children:e.jsx(z,{inputRef:T,id:"password-textfield",label:r("Password"),variant:"outlined",required:!0,fullWidth:!0,disabled:P,value:a,error:Q,onChange:s=>L(s.target.value),onFocus:()=>U(!1),type:q?"text":"password",autoComplete:"current-password",onKeyDown:$,onKeyUp:ee,slotProps:{input:{endAdornment:e.jsx(ue,{position:"end",children:e.jsx(ie,{"aria-label":"toggle password visibility",edge:"end",size:"large",onMouseDown:()=>f(!0),onMouseUp:()=>f(!1),onMouseLeave:()=>f(!1),onTouchStart:()=>f(!0),onTouchEnd:()=>f(!1),onTouchCancel:()=>f(!1),onKeyDown:s=>{s.key===" "&&(f(!0),s.preventDefault())},onKeyUp:s=>{s.key===" "&&(f(!1),s.preventDefault())},children:q?e.jsx(de,{}):e.jsx(fe,{})})})}}})}),V?e.jsx(u,{size:{xs:12},marginX:2,children:e.jsxs(le,{severity:"warning",children:[e.jsx(he,{children:r("Warning")}),r(H?"The password was partially entered with Caps Lock":"The password was entered with Caps Lock")]})}):null,t.rememberMe?e.jsx(u,{size:{xs:12},className:C(d.actionRow),children:e.jsx(Pe,{control:e.jsx(Ae,{id:"remember-checkbox",disabled:P,checked:y,onChange:J,onKeyDown:te,value:"rememberMe",color:"primary"}),className:d.rememberMe,label:r("Remember me")})}):null,e.jsx(u,{size:{xs:12},children:e.jsx(G,{id:"sign-in-button",variant:"contained",color:"primary",fullWidth:!0,endIcon:X?e.jsx(N,{size:20}):null,disabled:P,onClick:g,children:r("Sign in")})}),t.passkeyLogin?e.jsx(Le,{disabled:t.disabled,rememberMe:t.rememberMe,onAuthenticationError:s=>b(s.message),onAuthenticationStart:()=>{w(""),L(""),t.onAuthenticationStart()},onAuthenticationStop:t.onAuthenticationStop,onAuthenticationSuccess:t.onAuthenticationSuccess}):null,t.resetPassword?e.jsx(u,{size:{xs:12},className:C(d.actionRow,d.flexEnd),children:e.jsx(we,{id:"reset-password-button",component:"button",onClick:Y,className:d.resetLink,underline:"hover",children:r("Reset password?")})}):null]})})})},Me=re()(t=>({actionRow:{display:"flex",flexDirection:"row",marginBottom:t.spacing(-1),marginTop:t.spacing(-1)},flexEnd:{justifyContent:"flex-end"},rememberMe:{flexGrow:1},resetLink:{cursor:"pointer",paddingBottom:13.5,paddingTop:13.5}}));export{Ve as default};
