import{j as t,U as ae,u as B,g as M,h as W,aC as N,r as n,G as u,T as ie,q as Z,m as ce,p as le,c as ue,aD as de,aE as fe,t as he,ak as me,aF as ge}from"./index.t7Hp6wWA.js";import{I as we,V as xe,a as be,A as ye}from"./mui.VisibilityOff.C0Vodw9A.js";import{j as G,a as pe,B as H,h as Se}from"./constants.constants.D9Jh23gv.js";import{u as O}from"./hooks.Mounted.BhidXhBk.js";import{u as ke}from"./hooks.OpenIDConnect.RqyKR777.js";import{L as Ce}from"./layouts.Login.DLs9S7Cd.js";import{p as je,I as Re}from"./services.Password.DB-Dxij9.js";import{c as ve,e as Ae,h as Ee,i as Pe,p as Te}from"./services.WebAuthn.Dn9nSaU_.js";import{B as Le,C as Me}from"./broadcast-channel.avbFvJ_N.js";import{F as qe,T as K}from"./mui.TextField.BMu1N8UI.js";import{F as Fe}from"./mui.FormControlLabel.oDEBs5nP.js";import"./layouts.usePortalStyles.CQncL4s1.js";import"./browserSupportsWebAuthn.Bhlk1eaM.js";const Ie=function(){return t.jsx(ae,{children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",height:24,width:24,viewBox:"0 -960 960 960",fill:"#e8eaed",children:t.jsx("path",{d:"M120-160v-112q0-34 17.5-62.5T184-378q62-31 126-46.5T440-440q20 0 40 1.5t40 4.5q-4 58 21 109.5t73 84.5v80H120ZM760-40l-60-60v-186q-44-13-72-49.5T600-420q0-58 41-99t99-41q58 0 99 41t41 99q0 45-25.5 80T790-290l50 50-60 60 60 60-80 80ZM440-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm300 80q17 0 28.5-11.5T780-440q0-17-11.5-28.5T740-480q-17 0-28.5 11.5T700-440q0 17 11.5 28.5T740-400Z"})})})},De=function(e){const{t:r}=B(),d=M(W),C=M(N),{id:A,flow:j,subflow:R}=G(),c=O(),[b,v]=n.useState(!1),l=n.useRef(e.onAuthenticationError),m=n.useRef(e.onAuthenticationSuccess);n.useEffect(()=>{l.current=e.onAuthenticationError},[e.onAuthenticationError]),n.useEffect(()=>{m.current=e.onAuthenticationSuccess},[e.onAuthenticationSuccess]);const y=n.useCallback(()=>{e.onAuthenticationStart(),v(!0)},[e]),i=n.useCallback(()=>{e.onAuthenticationStop(),v(!1)},[e]),p=n.useCallback(async()=>{if(!(!c.current||b)){y();try{const g=await ve();if(g.status!==200||g.options==null){if(!c.current)return;i(),l.current(new Error(r("Failed to initiate security key sign in process")));return}const o=await Ae(g.options);if(o.result!==Ee.Success){if(!c.current)return;i(),l.current(new Error(r(Pe(o.result))));return}if(o.response==null){if(!c.current)return;l.current(new Error(r("The browser did not respond with the expected attestation data"))),i();return}if(!c.current)return;const w=await Te(o.response,e.rememberMe,d,C,A,j,R);if(!c.current)return;if(i(),w.data.status==="OK"&&w.status===200){m.current(w.data.data?w.data.data.redirect:void 0);return}if(!c.current)return;l.current(new Error(r("The server rejected the security key")))}catch(g){if(!c.current)return;i(),console.error(g),l.current(new Error(r("Failed to initiate security key sign in process")))}}},[c,b,y,e,d,C,A,j,R,i,l,m,r]);return t.jsxs(n.Fragment,{children:[t.jsx(u,{size:{xs:12},children:t.jsx(pe,{component:"div",role:"presentation",children:t.jsx(ie,{sx:{textTransform:"uppercase"},children:r("or")})})}),t.jsx(u,{size:{xs:12},children:t.jsx(H,{id:"passkey-sign-in-button",variant:"contained",color:"primary",fullWidth:!0,onClick:p,startIcon:t.jsx(Ie,{}),disabled:e.disabled,endIcon:b?t.jsx(Z,{size:20}):null,children:r("Sign in with a passkey")})})]})},Ye=function(e){const{t:r}=B(),{classes:d,cx:C}=Ue(),A=le(),j=M(W),R=M(N),{id:c,flow:b,subflow:v}=G(),l=ke(),{createErrorNotification:m}=ue(),y=O(),i=n.useMemo(()=>new Le("login"),[]),[p,g]=n.useState(!1),[o,w]=n.useState(""),[V,E]=n.useState(!1),[a,q]=n.useState(""),[I,f]=n.useState(!1),[Q,D]=n.useState(!1),[X,U]=n.useState(!1),[J,z]=n.useState(!1),[Y,F]=n.useState(!1),P=n.useRef(null),T=n.useRef(null),S=n.useCallback(()=>{P.current!==null&&P.current.focus()},[P]),h=n.useCallback(()=>{T.current!==null&&T.current.focus()},[T]);n.useEffect(()=>{const s=setTimeout(()=>S(),10);return()=>clearTimeout(s)},[S]),n.useEffect(()=>{const s=k=>{k&&e.onChannelStateChange()};return i.addEventListener("message",s),()=>{i.removeEventListener("message",s),i.close().catch(k=>console.error("Failed to close login broadcast channel",k))}},[i,e]);const L=e.disabled,_=de(),$=fe(),ee=()=>{g(!p)},x=n.useCallback(async()=>{if(o===""||a===""){o===""&&E(!0),a===""&&z(!0);return}F(!0),e.onAuthenticationStart();try{const s=await je(o,a,p,j,R,c,b,v,l);if(!y.current)return;F(!1),await i.postMessage(!0),e.onAuthenticationSuccess(s?s.redirect:void 0)}catch(s){if(console.error(s),!y.current)return;m(r("Incorrect username or password")),F(!1),e.onAuthenticationStop(),q(""),h()}},[o,a,e,p,j,R,c,b,v,l,i,m,r,h,y]),te=()=>{e.resetPassword&&(e.resetPasswordCustomURL!==""?window.open(e.resetPasswordCustomURL):A(ge))},se=n.useCallback(s=>{s.key==="Enter"&&(o.length?o.length&&a.length?x().catch(console.error):(E(!1),h()):E(!0))},[h,x,a.length,o.length]),ne=n.useCallback(s=>{s.key==="Enter"&&(o.length?a.length||h():S(),x().catch(console.error),s.preventDefault())},[h,S,x,a.length,o.length]),re=n.useCallback(s=>{if(a.length<=1&&(D(!1),U(!1),a.length===0))return;const k=Re(s);k!==null&&(k?D(!0):U(!0))},[a.length]),oe=n.useCallback(s=>{s.key==="Enter"&&(o.length?a.length||h():S(),x().catch(console.error))},[h,S,x,a.length,o.length]);return t.jsx(Ce,{id:"first-factor-stage",title:_,subtitle:$,children:t.jsx(qe,{id:"form-login",children:t.jsxs(u,{container:!0,spacing:2,children:[t.jsx(u,{size:{xs:12},children:t.jsx(K,{inputRef:P,id:"username-textfield",label:r("Username"),variant:"outlined",required:!0,value:o,error:V,disabled:L,fullWidth:!0,onChange:s=>w(s.target.value),onFocus:()=>E(!1),autoCapitalize:"none",autoComplete:"username",onKeyDown:se})}),t.jsx(u,{size:{xs:12},children:t.jsx(K,{inputRef:T,id:"password-textfield",label:r("Password"),variant:"outlined",required:!0,fullWidth:!0,disabled:L,value:a,error:J,onChange:s=>q(s.target.value),onFocus:()=>z(!1),type:I?"text":"password",autoComplete:"current-password",onKeyDown:ne,onKeyUp:re,slotProps:{input:{endAdornment:t.jsx(we,{position:"end",children:t.jsx(he,{"aria-label":"toggle password visibility",edge:"end",size:"large",onMouseDown:()=>f(!0),onMouseUp:()=>f(!1),onMouseLeave:()=>f(!1),onTouchStart:()=>f(!0),onTouchEnd:()=>f(!1),onTouchCancel:()=>f(!1),onKeyDown:s=>{s.key===" "&&(f(!0),s.preventDefault())},onKeyUp:s=>{s.key===" "&&(f(!1),s.preventDefault())},children:I?t.jsx(xe,{}):t.jsx(be,{})})})}}})}),Q?t.jsx(u,{size:{xs:12},marginX:2,children:t.jsxs(me,{severity:"warning",children:[t.jsx(ye,{children:r("Warning")}),r(X?"The password was partially entered with Caps Lock":"The password was entered with Caps Lock")]})}):null,e.rememberMe?t.jsx(u,{size:{xs:12},className:C(d.actionRow),children:t.jsx(Fe,{control:t.jsx(Me,{id:"remember-checkbox",disabled:L,checked:p,onChange:ee,onKeyDown:oe,value:"rememberMe",color:"primary"}),className:d.rememberMe,label:r("Remember me")})}):null,t.jsx(u,{size:{xs:12},children:t.jsx(H,{id:"sign-in-button",variant:"contained",color:"primary",fullWidth:!0,endIcon:Y?t.jsx(Z,{size:20}):null,disabled:L,onClick:x,children:r("Sign in")})}),e.passkeyLogin?t.jsx(De,{disabled:e.disabled,rememberMe:e.rememberMe,onAuthenticationError:s=>m(s.message),onAuthenticationStart:()=>{w(""),q(""),e.onAuthenticationStart()},onAuthenticationStop:e.onAuthenticationStop,onAuthenticationSuccess:e.onAuthenticationSuccess}):null,e.resetPassword?t.jsx(u,{size:{xs:12},className:C(d.actionRow,d.flexEnd),children:t.jsx(Se,{id:"reset-password-button",component:"button",onClick:te,className:d.resetLink,underline:"hover",children:r("Reset password?")})}):null]})})})},Ue=ce()(e=>({actionRow:{display:"flex",flexDirection:"row",marginTop:e.spacing(-1),marginBottom:e.spacing(-1)},resetLink:{cursor:"pointer",paddingTop:13.5,paddingBottom:13.5},rememberMe:{flexGrow:1},flexEnd:{justifyContent:"flex-end"}}));export{Ye as default};
