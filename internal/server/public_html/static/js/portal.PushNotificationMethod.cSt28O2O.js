import{u as U,m as M,r as c,g as H,h as O,A as b,j as u,B as P}from"./index.t7Hp6wWA.js";import{F as Y}from"./components.FailureIcon.C8UZ-YzZ.js";import{P as q}from"./components.PushNotificationIcon.Cq18F1CP.js";import{S as G}from"./components.SuccessIcon.BwM3O0fW.js";import{j as Q,B as $}from"./constants.constants.D9Jh23gv.js";import{u as z}from"./hooks.Mounted.BhidXhBk.js";import{u as J}from"./hooks.OpenIDConnect.RqyKR777.js";import{i as K,c as V,a as W,D as X}from"./portal.DeviceSelectionContainer.DAiU6FbD.js";import{D as Z,S}from"./portal.MethodContainer.DiPfdMku.js";import"./components.InformationIcon.Eb8nEF1O.js";import"./portal.Authenticated.DJMskO5J.js";var ee=(r=>(r[r.SignInInProgress=1]="SignInInProgress",r[r.Success=2]="Success",r[r.Failure=3]="Failure",r[r.Selection=4]="Selection",r[r.Enroll=5]="Enroll",r[r.RateLimited=6]="RateLimited",r))(ee||{});const me=function(r){const{t:n}=U(),{classes:_}=re(),{id:y,flow:g,subflow:T}=Q(),k=J(),[a,t]=c.useState(1),R=H(O),o=z(),[p,I]=c.useState(""),[F,x]=c.useState([]),{onSignInSuccess:E,onSignInError:w,registered:C,onSelectionClick:L}=r,i=c.useRef(w),m=c.useRef(E),l=c.useRef(null),s=c.useRef(null);c.useEffect(()=>{i.current=w},[w]),c.useEffect(()=>{m.current=E},[E]),c.useEffect(()=>()=>{l.current!==null&&(clearTimeout(l.current),l.current=null),s.current!==null&&(clearTimeout(s.current),s.current=null)},[]);const j=c.useCallback(e=>{l.current&&clearTimeout(l.current),t(6),i.current(new Error(n("You have made too many requests"))),l.current=setTimeout(()=>{if(!o.current){l.current=null;return}t(3),l.current=null},e*1e3)},[o,i,n]),A=c.useCallback(async()=>{try{const e=await K();if(!o.current)return;switch(e.result){case"auth":let d=[];e.devices.forEach(f=>d.push({id:f.device,name:f.display_name,methods:f.capabilities})),x(d),t(4);break;case"allow":i.current(new Error(n("Device selection was bypassed by Duo policy"))),t(2);break;case"deny":i.current(new Error(n("Device selection was denied by Duo policy"))),t(3);break;case"enroll":i.current(new Error(n("No compatible device found"))),e.enroll_url&&r.duoSelfEnrollment&&I(e.enroll_url),t(5);break}}catch(e){if(!o.current)return;console.error(e),i.current(new Error(n("There was an issue fetching Duo device(s)")))}},[r.duoSelfEnrollment,o,i,n]),v=c.useCallback(async()=>{if(r.authenticationLevel!==b.TwoFactor)try{t(1);const e=await V(R,y,g,T,k);if(!o.current)return;if(e)if(e.data&&!e.limited)switch(e.data.result){case"auth":let d=[];e.data.devices.forEach(f=>d.push({id:f.device,name:f.display_name,methods:f.capabilities})),x(d),t(4);break;case"enroll":i.current(new Error(n("No compatible device found"))),e.data.enroll_url&&r.duoSelfEnrollment&&I(e.data.enroll_url),t(5);break;case"deny":i.current(new Error(n("Device selection was denied by Duo policy"))),t(3);break;default:t(2),s.current&&clearTimeout(s.current),s.current=setTimeout(()=>{o.current&&(s.current=null,m.current(e.data?e.data.redirect:void 0))},1500)}else e.limited?j(e.retryAfter):(t(2),s.current&&clearTimeout(s.current),s.current=setTimeout(()=>{o.current&&(s.current=null,m.current(e.data?e.data.redirect:void 0))},1500));else i.current(new Error(n("There was an issue completing sign in process"))),t(3)}catch(e){if(!o.current||a!==1)return;console.error(e),i.current(new Error(n("There was an issue completing sign in process"))),t(3)}},[r.authenticationLevel,r.duoSelfEnrollment,R,y,g,T,k,o,i,n,m,j,a]),N=c.useCallback(async function(e){try{if(await W(e),!o.current)return;C?t(1):(t(1),L())}catch(d){console.error(d),i.current(new Error(n("There was an issue updating preferred Duo device")))}},[o,L,i,C,n]),B=c.useCallback(e=>{N({device:e.id,method:e.method})},[N]);if(c.useEffect(()=>{r.authenticationLevel>=b.TwoFactor&&t(2)},[r.authenticationLevel,t]),c.useEffect(()=>{a===1&&v()},[v,a]),a===4)return u.jsx(X,{devices:F,onBack:()=>t(1),onSelect:B});let h;switch(a){case 1:h=u.jsx(q,{width:64,height:64,animated:!0});break;case 2:h=u.jsx(G,{});break;case 3:h=u.jsx(Y,{})}let D=S.METHOD;return r.authenticationLevel===b.TwoFactor?D=S.ALREADY_AUTHENTICATED:a===5&&(D=S.NOT_REGISTERED),u.jsxs(Z,{id:r.id,title:n("Push Notification"),explanation:n("A notification has been sent to your smartphone"),duoSelfEnrollment:p?r.duoSelfEnrollment:!1,registered:r.registered,state:D,onSelectClick:A,onRegisterClick:()=>window.open(p,"_blank"),children:[u.jsx(P,{className:_.icon,children:h}),u.jsx(P,{className:a!==3?"hidden":"",children:u.jsx($,{color:"secondary",onClick:v,children:n("Retry")})})]})},re=M()(r=>({icon:{width:"64px",height:"64px",display:"inline-block"}}));export{ee as State,me as default};
