import{j as e,U as oe,u as B,g as E,h as W,aB as N,r as n,G as d,T as ie,q as Z,m as le,p as ce,c as ue,aC as de,aD as fe,t as he,ak as me,aE as we}from"./index.BAKKlMLi.js";import{I as ge,V as xe,a as pe,A as be}from"./mui.VisibilityOff.BlDave3-.js";import{j as G,a as ye,B as H,h as ke}from"./constants.constants.Dc-vougk.js";import{u as O}from"./hooks.Mounted.Bo5u1Dd8.js";import{u as Ce}from"./hooks.OpenIDConnect.g4Kxe8nK.js";import{L as Se}from"./layouts.Login.pFj0R2ko.js";import{p as je,I as Re}from"./services.Password.E-F53CWz.js";import{c as ve,e as Pe,h as Ae,i as Te,p as Ee}from"./services.WebAuthn.BxskKmEB.js";import{B as Le,C as Me}from"./broadcast-channel.CMAPgz5L.js";import{F as qe,T as K}from"./mui.TextField.DDjkj3Bi.js";import{F as Fe}from"./mui.FormControlLabel.B9CBTFc_.js";import"./layouts.usePortalStyles.DPt9DQ4Y.js";import"./browserSupportsWebAuthn.Bhlk1eaM.js";const Ie=function(){return e.jsx(oe,{children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",height:24,width:24,viewBox:"0 -960 960 960",fill:"#e8eaed",children:e.jsx("path",{d:"M120-160v-112q0-34 17.5-62.5T184-378q62-31 126-46.5T440-440q20 0 40 1.5t40 4.5q-4 58 21 109.5t73 84.5v80H120ZM760-40l-60-60v-186q-44-13-72-49.5T600-420q0-58 41-99t99-41q58 0 99 41t41 99q0 45-25.5 80T790-290l50 50-60 60 60 60-80 80ZM440-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm300 80q17 0 28.5-11.5T780-440q0-17-11.5-28.5T740-480q-17 0-28.5 11.5T700-440q0 17 11.5 28.5T740-400Z"})})})},De=function(t){const{t:r}=B(),f=E(W),C=E(N),{id:R,flow:g,subflow:S}=G(),c=O(),[x,j]=n.useState(!1),u=n.useRef(t.onAuthenticationError).current,p=n.useCallback(()=>{t.onAuthenticationStart(),j(!0)},[t]),i=n.useCallback(()=>{t.onAuthenticationStop(),j(!1)},[t]),b=n.useCallback(async()=>{if(!(!c||x)){p();try{const l=await ve();if(l.status!==200||l.options==null){i(),u(new Error(r("Failed to initiate security key sign in process")));return}const y=await Pe(l.options);if(y.result!==Ae.Success){if(!c.current)return;i(),u(new Error(r(Te(y.result))));return}if(y.response==null){u(new Error(r("The browser did not respond with the expected attestation data"))),i();return}if(!c.current)return;const a=await Ee(y.response,t.rememberMe,f,C,R,g,S);if(i(),a.data.status==="OK"&&a.status===200){t.onAuthenticationSuccess(a.data.data?a.data.data.redirect:void 0);return}if(!c.current)return;u(new Error(r("The server rejected the security key")))}catch(l){if(i(),!c.current)return;console.error(l),u(new Error(r("Failed to initiate security key sign in process")))}}},[c,x,p,t,f,C,R,g,S,i,u,r]);return e.jsxs(n.Fragment,{children:[e.jsx(d,{size:{xs:12},children:e.jsx(ye,{component:"div",role:"presentation",children:e.jsx(ie,{sx:{textTransform:"uppercase"},children:r("or")})})}),e.jsx(d,{size:{xs:12},children:e.jsx(H,{id:"passkey-sign-in-button",variant:"contained",color:"primary",fullWidth:!0,onClick:b,startIcon:e.jsx(Ie,{}),disabled:t.disabled,endIcon:x?e.jsx(Z,{size:20}):null,children:r("Sign in with a passkey")})})]})},Ye=function(t){const{t:r}=B(),{classes:f,cx:C}=Ue(),R=ce(),g=E(W),S=E(N),{id:c,flow:x,subflow:j}=G(),u=Ce(),{createErrorNotification:p}=ue(),i=O(),b=n.useMemo(()=>new Le("login"),[]),[l,y]=n.useState(!1),[a,q]=n.useState(""),[V,v]=n.useState(!1),[o,L]=n.useState(""),[F,h]=n.useState(!1),[Q,I]=n.useState(!1),[X,D]=n.useState(!1),[J,U]=n.useState(!1),[Y,M]=n.useState(!1),P=n.useRef(null),A=n.useRef(null),k=n.useCallback(()=>{P.current!==null&&P.current.focus()},[P]),m=n.useCallback(()=>{A.current!==null&&A.current.focus()},[A]);n.useEffect(()=>{const s=setTimeout(()=>k(),10);return()=>clearTimeout(s)},[k]),n.useEffect(()=>{b.addEventListener("message",s=>{s&&t.onChannelStateChange()})},[b,g,t]);const T=t.disabled,_=de(),$=fe(),ee=()=>{y(!l)},w=n.useCallback(async()=>{if(a===""||o===""){a===""&&v(!0),o===""&&U(!0);return}M(!0),t.onAuthenticationStart();try{const s=await je(a,o,l,g,S,c,x,j,u);if(!i.current)return;M(!1),await b.postMessage(!0),t.onAuthenticationSuccess(s?s.redirect:void 0)}catch(s){if(console.error(s),!i.current)return;p(r("Incorrect username or password")),M(!1),t.onAuthenticationStop(),L(""),m()}},[a,o,t,l,g,S,c,x,j,u,b,p,r,m,i]),te=()=>{t.resetPassword&&(t.resetPasswordCustomURL!==""?window.open(t.resetPasswordCustomURL):R(we))},se=n.useCallback(s=>{s.key==="Enter"&&(a.length?a.length&&o.length?w().catch(console.error):(v(!1),m()):v(!0))},[m,w,o.length,a.length]),ne=n.useCallback(s=>{s.key==="Enter"&&(a.length?o.length||m():k(),w().catch(console.error),s.preventDefault())},[m,k,w,o.length,a.length]),re=n.useCallback(s=>{if(o.length<=1&&(I(!1),D(!1),o.length===0))return;const z=Re(s);z!==null&&(z?I(!0):D(!0))},[o.length]),ae=n.useCallback(s=>{s.key==="Enter"&&(a.length?o.length||m():k(),w().catch(console.error))},[m,k,w,o.length,a.length]);return e.jsx(Se,{id:"first-factor-stage",title:_,subtitle:$,children:e.jsx(qe,{id:"form-login",children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsx(d,{size:{xs:12},children:e.jsx(K,{inputRef:P,id:"username-textfield",label:r("Username"),variant:"outlined",required:!0,value:a,error:V,disabled:T,fullWidth:!0,onChange:s=>q(s.target.value),onFocus:()=>v(!1),autoCapitalize:"none",autoComplete:"username",onKeyDown:se})}),e.jsx(d,{size:{xs:12},children:e.jsx(K,{inputRef:A,id:"password-textfield",label:r("Password"),variant:"outlined",required:!0,fullWidth:!0,disabled:T,value:o,error:J,onChange:s=>L(s.target.value),onFocus:()=>U(!1),type:F?"text":"password",autoComplete:"current-password",onKeyDown:ne,onKeyUp:re,slotProps:{input:{endAdornment:e.jsx(ge,{position:"end",children:e.jsx(he,{"aria-label":"toggle password visibility",edge:"end",size:"large",onMouseDown:()=>h(!0),onMouseUp:()=>h(!1),onMouseLeave:()=>h(!1),onTouchStart:()=>h(!0),onTouchEnd:()=>h(!1),onTouchCancel:()=>h(!1),onKeyDown:s=>{s.key===" "&&(h(!0),s.preventDefault())},onKeyUp:s=>{s.key===" "&&(h(!1),s.preventDefault())},children:F?e.jsx(xe,{}):e.jsx(pe,{})})})}}})}),Q?e.jsx(d,{size:{xs:12},marginX:2,children:e.jsxs(me,{severity:"warning",children:[e.jsx(be,{children:r("Warning")}),r(X?"The password was partially entered with Caps Lock":"The password was entered with Caps Lock")]})}):null,t.rememberMe?e.jsx(d,{size:{xs:12},className:C(f.actionRow),children:e.jsx(Fe,{control:e.jsx(Me,{id:"remember-checkbox",disabled:T,checked:l,onChange:ee,onKeyDown:ae,value:"rememberMe",color:"primary"}),className:f.rememberMe,label:r("Remember me")})}):null,e.jsx(d,{size:{xs:12},children:e.jsx(H,{id:"sign-in-button",variant:"contained",color:"primary",fullWidth:!0,endIcon:Y?e.jsx(Z,{size:20}):null,disabled:T,onClick:w,children:r("Sign in")})}),t.passkeyLogin?e.jsx(De,{disabled:t.disabled,rememberMe:t.rememberMe,onAuthenticationError:s=>p(s.message),onAuthenticationStart:()=>{q(""),L(""),t.onAuthenticationStart()},onAuthenticationStop:t.onAuthenticationStop,onAuthenticationSuccess:t.onAuthenticationSuccess}):null,t.resetPassword?e.jsx(d,{size:{xs:12},className:C(f.actionRow,f.flexEnd),children:e.jsx(ke,{id:"reset-password-button",component:"button",onClick:te,className:f.resetLink,underline:"hover",children:r("Reset password?")})}):null]})})})},Ue=le()(t=>({actionRow:{display:"flex",flexDirection:"row",marginTop:t.spacing(-1),marginBottom:t.spacing(-1)},resetLink:{cursor:"pointer",paddingTop:13.5,paddingBottom:13.5},rememberMe:{flexGrow:1},flexEnd:{justifyContent:"flex-end"}}));export{Ye as default};
