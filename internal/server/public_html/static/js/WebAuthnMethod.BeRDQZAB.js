import{u as b,g as k,h as I,r as a,A as R,j as T}from"./index.B4PwAJYr.js";import{W as F}from"./WebAuthnTryIcon.D7PvPwU3.js";import{j as C}from"./constants.BRYNkPs0.js";import{u as W}from"./Mounted.BG9LrPxO.js";import{u as x}from"./OpenIDConnect.BYQbFf51.js";import{W as r,j,e as D,h as L,i as v,k as M}from"./WebAuthn.CFYowaSM.js";import{D as O,S as f}from"./MethodContainer.tfA7MAuH.js";import"./FailureIcon.Dk8ko9mP.js";import"./SuccessIcon.DECb_tfH.js";import"./TimerIcon._wOedlIX.js";import"./Timer.DGBZWIJf.js";import"./IconWithContext.uVFIwzaz.js";import"./browserSupportsWebAuthn.Bhlk1eaM.js";import"./InformationIcon.Dl9J4f7w.js";import"./Authenticated.DnFEts74.js";const Z=function(e){const{t}=b(),h=k(I),{id:m,flow:S,subflow:g}=C(),E=x(),o=W(),[y,n]=a.useState(r.WaitTouch),{onSignInSuccess:p,onSignInError:A}=e,s=a.useRef(A).current,w=a.useRef(p).current,l=a.useCallback(async()=>{if(!(!e.registered||e.authenticationLevel===R.TwoFactor))try{n(r.WaitTouch);const i=await j();if(i.status!==200||i.options==null){n(r.Failure),s(new Error(t("Failed to initiate security key sign in process")));return}const u=await D(i.options);if(u.result!==L.Success){if(!o.current)return;n(r.Failure),s(new Error(t(v(u.result))));return}if(u.response==null){s(new Error(t("The browser did not respond with the expected attestation data"))),n(r.Failure);return}if(!o.current)return;n(r.InProgress);const c=await M(u.response,h,m,S,g,E);if(c.data.status==="OK"&&c.status===200){w(c.data.data?c.data.data.redirect:void 0);return}if(!o.current)return;s(new Error(t("The server rejected the security key"))),n(r.Failure)}catch(i){if(!o.current)return;console.error(i),s(new Error(t("Failed to initiate security key sign in process"))),n(r.Failure)}},[e.registered,e.authenticationLevel,o,h,m,S,g,E,s,t,w]);a.useEffect(()=>{l().catch(console.error)},[l]);let d=f.METHOD;return e.authenticationLevel===R.TwoFactor?d=f.ALREADY_AUTHENTICATED:e.registered||(d=f.NOT_REGISTERED),T.jsx(O,{id:e.id,title:t("Security Key"),explanation:t("Touch the token of your security key"),duoSelfEnrollment:!1,registered:e.registered,state:d,onRegisterClick:e.onRegisterClick,children:T.jsx(F,{onRetryClick:l,webauthnTouchState:y})})};export{Z as default};
