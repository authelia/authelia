import{u as F,m as A,r as o,g as B,h as U,A as E,j as c,B as C}from"./index.aN1zXoDM.js";import{F as M}from"./components.FailureIcon.PH9Df4fi.js";import{P as H}from"./components.PushNotificationIcon.ZXBtSVLa.js";import{S as O}from"./components.SuccessIcon.C7yq4zu8.js";import{j as Y,B as q}from"./constants.constants.BnGwwtlq.js";import{u as G}from"./hooks.Mounted.BUoxNd2d.js";import{u as Q}from"./hooks.OpenIDConnect.ByE4cm2n.js";import{i as $,c as z,a as J,D as K}from"./portal.DeviceSelectionContainer.Bf06DvAV.js";import{D as V,S as v}from"./portal.MethodContainer.Bnj_0SjL.js";import"./components.InformationIcon.CVryNOl2.js";import"./portal.Authenticated.BorPWeDY.js";var W=(e=>(e[e.SignInInProgress=1]="SignInInProgress",e[e.Success=2]="Success",e[e.Failure=3]="Failure",e[e.Selection=4]="Selection",e[e.Enroll=5]="Enroll",e[e.RateLimited=6]="RateLimited",e))(W||{});const ue=function(e){const{t:n}=F(),{classes:L}=X(),{id:D,flow:b,subflow:S}=Y(),y=Q(),[s,r]=o.useState(1),k=B(U),a=G(),[g,T]=o.useState(""),[j,I]=o.useState([]),{onSignInSuccess:p,onSignInError:N}=e,i=o.useRef(N).current,m=o.useRef(p).current,d=o.useRef(null);o.useEffect(()=>{if(d.current!==null)return clearTimeout(d.current)},[]);const R=o.useCallback(t=>{d.current&&clearTimeout(d.current),r(6),i(new Error(n("You have made too many requests"))),d.current=setTimeout(()=>{r(3),d.current=null},t*1e3)},[i,n]),P=o.useCallback(async()=>{try{const t=await $();if(!a.current)return;switch(t.result){case"auth":let l=[];t.devices.forEach(u=>l.push({id:u.device,name:u.display_name,methods:u.capabilities})),I(l),r(4);break;case"allow":i(new Error(n("Device selection was bypassed by Duo policy"))),r(2);break;case"deny":i(new Error(n("Device selection was denied by Duo policy"))),r(3);break;case"enroll":i(new Error(n("No compatible device found"))),t.enroll_url&&e.duoSelfEnrollment&&T(t.enroll_url),r(5);break}}catch(t){if(!a.current)return;console.error(t),i(new Error(n("There was an issue fetching Duo device(s)")))}},[e.duoSelfEnrollment,a,i,n]),h=o.useCallback(async()=>{if(e.authenticationLevel!==E.TwoFactor)try{r(1);const t=await z(k,D,b,S,y);if(!a.current)return;if(t)if(t.data&&!t.limited)switch(t.data.result){case"auth":let l=[];t.data.devices.forEach(u=>l.push({id:u.device,name:u.display_name,methods:u.capabilities})),I(l),r(4);break;case"enroll":i(new Error(n("No compatible device found"))),t.data.enroll_url&&e.duoSelfEnrollment&&T(t.data.enroll_url),r(5);break;case"deny":i(new Error(n("Device selection was denied by Duo policy"))),r(3);break;default:r(2),setTimeout(()=>{a.current&&m(t.data?t.data.redirect:void 0)},1500)}else t.limited?R(t.retryAfter):(r(2),setTimeout(()=>{a.current&&m(t.data?t.data.redirect:void 0)},1500));else i(new Error(n("There was an issue completing sign in process"))),r(3)}catch(t){if(!a.current||s!==1)return;console.error(t),i(new Error(n("There was an issue completing sign in process"))),r(3)}},[e.authenticationLevel,e.duoSelfEnrollment,k,D,b,S,y,a,i,n,m,R,s]),x=o.useCallback(async function(t){try{await J(t),e.registered?r(1):(r(1),e.onSelectionClick())}catch(l){console.error(l),i(new Error(n("There was an issue updating preferred Duo device")))}},[i,e,n]),_=o.useCallback(t=>{x({device:t.id,method:t.method})},[x]);if(o.useEffect(()=>{e.authenticationLevel>=E.TwoFactor&&r(2)},[e.authenticationLevel,r]),o.useEffect(()=>{s===1&&h()},[h,s]),s===4)return c.jsx(K,{devices:j,onBack:()=>r(1),onSelect:_});let f;switch(s){case 1:f=c.jsx(H,{width:64,height:64,animated:!0});break;case 2:f=c.jsx(O,{});break;case 3:f=c.jsx(M,{})}let w=v.METHOD;return e.authenticationLevel===E.TwoFactor?w=v.ALREADY_AUTHENTICATED:s===5&&(w=v.NOT_REGISTERED),c.jsxs(V,{id:e.id,title:n("Push Notification"),explanation:n("A notification has been sent to your smartphone"),duoSelfEnrollment:g?e.duoSelfEnrollment:!1,registered:e.registered,state:w,onSelectClick:P,onRegisterClick:()=>window.open(g,"_blank"),children:[c.jsx(C,{className:L.icon,children:f}),c.jsx(C,{className:s!==3?"hidden":"",children:c.jsx(q,{color:"secondary",onClick:h,children:n("Retry")})})]})},X=A()(e=>({icon:{width:"64px",height:"64px",display:"inline-block"}}));export{W as State,ue as default};
