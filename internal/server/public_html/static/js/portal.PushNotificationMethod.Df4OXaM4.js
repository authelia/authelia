import{u as H,m as O,r,A as u,g as Y,h as q,j as s,B as N}from"./index.J4YSomth.js";import{F as G}from"./components.FailureIcon.C8E_4zaM.js";import{P as Q}from"./components.PushNotificationIcon.C7hpP1zN.js";import{S as $}from"./components.SuccessIcon.C3pLKly2.js";import{j as z,B as J}from"./constants.constants.BvDkw1BZ.js";import{u as K}from"./hooks.Mounted.CNeV72_h.js";import{u as V}from"./hooks.OpenIDConnect.fHo8fPKW.js";import{g as W,i as X,c as Z,a as ee,D as te}from"./portal.DeviceSelectionContainer.lMQQYXqJ.js";import{D as re,S}from"./portal.MethodContainer.B7LucbyW.js";import"./components.InformationIcon.Hu39YtA5.js";import"./portal.Authenticated.KMDfbGon.js";var ne=(t=>(t[t.SignInInProgress=1]="SignInInProgress",t[t.Success=2]="Success",t[t.Failure=3]="Failure",t[t.Selection=4]="Selection",t[t.Enroll=5]="Enroll",t[t.RateLimited=6]="RateLimited",t))(ne||{});const we=function(t){const{t:n}=H(),{classes:p}=oe(),{flow:g,id:y,subflow:k}=z(),T=V(),[d,o]=r.useState(t.authenticationLevel>=u.TwoFactor?2:1),R=Y(q),a=K(),[L,I]=r.useState(""),[A,x]=r.useState([]),[D,f]=r.useState({}),{onSignInError:i,onSignInSuccess:C}=t,_=r.useRef(!1),F=r.useRef(null),l=r.useRef(null),h=r.useRef(null);r.useEffect(()=>()=>{l.current!==null&&(clearTimeout(l.current),l.current=null),h.current!==null&&(clearTimeout(h.current),h.current=null)},[]),r.useEffect(()=>{t.authenticationLevel<u.TwoFactor&&W().then(e=>{e.preferred_device&&e.preferred_method&&f({device:e.preferred_device,method:e.preferred_method})}).catch(e=>{console.debug("No preferred Duo device found or error fetching:",e)})},[t.authenticationLevel]);const v=r.useCallback(e=>e.map(c=>({id:c.device,methods:c.capabilities,name:c.display_name})),[]),E=r.useCallback(e=>{o(2),h.current=setTimeout(()=>{a.current&&(C(e),h.current=null)},1500)},[a,C]),P=r.useCallback(e=>{l.current&&clearTimeout(l.current),o(6),i(new Error(n("You have made too many requests"))),l.current=setTimeout(()=>{o(3),l.current=null},e*1e3)},[i,n]),U=r.useCallback(async()=>{try{const e=await X();if(!a.current)return;switch(e.preferred_device&&e.preferred_method&&f({device:e.preferred_device,method:e.preferred_method}),e.result){case"auth":{x(v(e.devices)),F.current=d,o(4);break}case"allow":i(new Error(n("Device selection was bypassed by Duo policy"))),o(2);break;case"deny":i(new Error(n("Device selection was denied by Duo policy"))),o(3);break;case"enroll":i(new Error(n("No compatible device found"))),e.enroll_url&&t.duoSelfEnrollment&&I(e.enroll_url),o(5);break}}catch(e){if(!a.current)return;console.error(e),i(new Error(n("There was an issue fetching Duo device(s)")))}},[a,i,n,t.duoSelfEnrollment,f,v,d]),m=r.useCallback(async()=>{if(t.authenticationLevel!==u.TwoFactor)try{o(1);const e=await Z(R,y,g,k,T);if(!a.current)return;if(!e)throw new Error(n("There was an issue completing sign in process"));if(e.limited){P(e.retryAfter);return}if(!e.data){E(void 0);return}switch(e.data.result){case"auth":x(v(e.data.devices)),o(4);break;case"enroll":i(new Error(n("No compatible device found"))),e.data.enroll_url&&t.duoSelfEnrollment&&I(e.data.enroll_url),o(5);break;case"deny":i(new Error(n("Device selection was denied by Duo policy"))),o(3);break;default:E(e.data.redirect)}}catch(e){if(!a.current)return;console.error(e),i(new Error(n("There was an issue completing sign in process"))),o(3)}},[t.authenticationLevel,t.duoSelfEnrollment,R,y,g,k,T,a,i,n,P,v,E]),j=r.useCallback(async function(e){try{await ee(e),t.registered||t.onSelectionClick()}catch(c){console.error(c),i(new Error(n("There was an issue updating preferred Duo device")))}},[i,t,n]),B=r.useCallback(e=>{const c={device:e.id,method:e.method},M=c.device!==D?.device||c.method!==D?.method;f(c),M?j(c).then(()=>{t.authenticationLevel>=u.TwoFactor?o(2):m()}).catch(()=>{o(3)}):t.authenticationLevel>=u.TwoFactor?o(2):o(1)},[j,D,m,f,t.authenticationLevel]);if(r.useEffect(()=>{t.authenticationLevel<u.TwoFactor&&!_.current&&(_.current=!0,m())},[t.authenticationLevel,m]),d===4)return s.jsx(te,{devices:A,onBack:()=>o(F.current||1),onSelect:B});let w;switch(d){case 1:w=s.jsx(Q,{width:64,height:64,animated:!0});break;case 2:w=s.jsx($,{});break;case 3:w=s.jsx(G,{})}let b=S.METHOD;return t.authenticationLevel===u.TwoFactor?b=S.ALREADY_AUTHENTICATED:d===5&&(b=S.NOT_REGISTERED),s.jsxs(re,{id:t.id,title:n("Push Notification"),explanation:n("A notification has been sent to your smartphone"),duoSelfEnrollment:L?t.duoSelfEnrollment:!1,registered:t.registered,state:b,onSelectClick:U,onRegisterClick:()=>window.open(L,"_blank","noopener,noreferrer"),children:[s.jsx(N,{className:p.icon,children:w}),s.jsx(N,{className:d===3?"":"hidden",children:s.jsx(J,{color:"secondary",onClick:m,children:n("Retry")})})]})},oe=O()(()=>({icon:{display:"inline-block",height:"64px",width:"64px"}}));export{ne as State,we as default};
