import{u as k,m as g,r as a,c as w,j as r,B as d}from"./index.CEiXDjRd.js";import{F as x}from"./components.FailureIcon.BImOlKSw.js";import{P as S}from"./components.PushNotificationIcon.C2Fasvks.js";import{i as F,c as j,a as P,D as C}from"./portal.DeviceSelectionContainer.B5Nr8DRh.js";import{B as N,t as T}from"./constants.constants.RkJrtp09.js";import"./components.SuccessIcon.9My8fVrT.js";const R={devices:[],status:"pushing"};function E(i,s){switch(s.type){case"setStatus":return{...i,status:s.status};case"setDevices":return{...i,devices:s.devices};case"startPush":return{...i,status:"pushing"};case"pushSuccess":return{...i,status:"success"};case"pushFailure":return{...i,status:"failure"};case"selectDevices":return{...i,devices:s.devices,status:"selecting"};case"rateLimited":return{...i,status:"rate_limited"};default:return i}}const Y=function(i){const{t:s}=k("portal"),{classes:p}=B(),[n,t]=a.useReducer(E,R),{createErrorNotification:c}=w(),u=a.useRef(null);a.useEffect(()=>()=>{u.current!==null&&(clearTimeout(u.current),u.current=null)},[]);const m=a.useCallback(e=>{u.current&&clearTimeout(u.current),t({type:"rateLimited"}),c(s("You have made too many requests")),u.current=setTimeout(()=>{t({type:"pushFailure"}),u.current=null},e*1e3)},[c,s]),y=a.useCallback(e=>{if(e)if(e.data&&!e.limited)switch(e.data.result){case"auth":{const o=[];for(const l of e.data.devices)o.push({id:l.device,methods:l.capabilities,name:l.display_name});t({devices:o,type:"selectDevices"});break}case"enroll":c(s("No compatible device found")),t({type:"pushFailure"});break;case"deny":c(s("Device selection was denied by Duo policy")),t({type:"pushFailure"});break;default:t({type:"pushSuccess"}),i.onSecondFactorSuccess();break}else e.limited?m(e.retryAfter):(c(s("There was an issue completing sign in process")),t({type:"pushFailure"}));else c(s("There was an issue completing sign in process")),t({type:"pushFailure"})},[c,m,i,s]),b=a.useCallback(async()=>{try{const e=await F();switch(e.result){case"auth":{const o=[];for(const l of e.devices)o.push({id:l.device,methods:l.capabilities,name:l.display_name});t({devices:o,type:"selectDevices"});break}case"allow":c(s("Device selection was bypassed by Duo policy")),t({type:"pushSuccess"});break;case"deny":c(s("Device selection was denied by Duo policy")),t({type:"pushFailure"});break;case"enroll":c(s("No compatible device found")),t({type:"pushFailure"});break}}catch(e){console.error(e),c(s("There was an issue fetching Duo device(s)"))}},[c,s]),f=a.useCallback(async()=>{try{const e=await j();y(e)}catch(e){console.error(e),c(s("There was an issue completing sign in process")),t({type:"pushFailure"})}},[y,c,s]),v=a.useCallback(async function(e){try{await P(e),t({type:"startPush"})}catch(o){console.error(o),console.error(new Error(s("There was an issue updating preferred Duo device")))}},[s]),D=a.useCallback(e=>{v({device:e.id,method:e.method})},[v]);if(a.useEffect(()=>{n.status==="pushing"&&f()},[n.status,f]),n.status==="selecting")return r.jsx(C,{devices:n.devices,onBack:()=>t({type:"startPush"}),onSelect:D});let h;switch(n.status){case"pushing":case"success":h=r.jsx(S,{width:64,height:64,animated:!0});break;case"failure":h=r.jsx(x,{})}return r.jsxs(a.Fragment,{children:[r.jsxs(d,{className:p.container,children:[r.jsx(d,{className:p.icon,children:h}),r.jsx(d,{className:n.status==="failure"?"":"hidden",children:r.jsx(N,{color:"secondary",onClick:()=>t({type:"startPush"}),children:"Retry"})})]}),n.status==="success"?null:r.jsx(d,{children:r.jsx(T,{component:"button",id:"selection-link",onClick:b,underline:"hover",children:s("Select a Device")})})]})},B=g()(()=>({container:{height:"120px"},icon:{display:"inline-block",height:"64px",width:"64px"}}));export{Y as default};
