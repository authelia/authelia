import{u as I,g as F,h as b,r as i,A as y,j as p}from"./index.t7Hp6wWA.js";import{W as k}from"./components.WebAuthnTryIcon.z13PfurJ.js";import{j as W}from"./constants.constants.D9Jh23gv.js";import{u as x}from"./hooks.Mounted.BhidXhBk.js";import{u as C}from"./hooks.OpenIDConnect.RqyKR777.js";import{W as n,j,e as D,h as L,i as v,k as M}from"./services.WebAuthn.Dn9nSaU_.js";import{D as O,S as E}from"./portal.MethodContainer.DiPfdMku.js";import"./components.FailureIcon.C8UZ-YzZ.js";import"./components.SuccessIcon.BwM3O0fW.js";import"./components.TimerIcon.B88ZJg0o.js";import"./hooks.Timer.UVxr6XFh.js";import"./portal.IconWithContext.C8zjEmy8.js";import"./browserSupportsWebAuthn.Bhlk1eaM.js";import"./components.InformationIcon.Eb8nEF1O.js";import"./portal.Authenticated.DJMskO5J.js";const Z=function(e){const{t}=I(),S=F(b),{id:g,flow:R,subflow:w}=W(),T=C(),r=x(),[A,s]=i.useState(n.WaitTouch),{onSignInSuccess:l,onSignInError:f}=e,o=i.useRef(f),d=i.useRef(l);i.useEffect(()=>{o.current=f},[f]),i.useEffect(()=>{d.current=l},[l]);const h=i.useCallback(async()=>{if(!(!e.registered||e.authenticationLevel===y.TwoFactor))try{s(n.WaitTouch);const u=await j();if(!r.current)return;if(u.status!==200||u.options==null){s(n.Failure),o.current(new Error(t("Failed to initiate security key sign in process")));return}const a=await D(u.options);if(a.result!==L.Success){if(!r.current)return;s(n.Failure),o.current(new Error(t(v(a.result))));return}if(a.response==null){if(!r.current)return;o.current(new Error(t("The browser did not respond with the expected attestation data"))),s(n.Failure);return}if(!r.current)return;s(n.InProgress);const c=await M(a.response,S,g,R,w,T);if(c.data.status==="OK"&&c.status===200){if(!r.current)return;d.current(c.data.data?c.data.data.redirect:void 0);return}if(!r.current)return;o.current(new Error(t("The server rejected the security key"))),s(n.Failure)}catch(u){if(!r.current)return;console.error(u),o.current(new Error(t("Failed to initiate security key sign in process"))),s(n.Failure)}},[e.registered,e.authenticationLevel,r,S,g,R,w,T,o,t,d]);i.useEffect(()=>{h().catch(console.error)},[h]);let m=E.METHOD;return e.authenticationLevel===y.TwoFactor?m=E.ALREADY_AUTHENTICATED:e.registered||(m=E.NOT_REGISTERED),p.jsx(O,{id:e.id,title:t("Security Key"),explanation:t("Touch the token of your security key"),duoSelfEnrollment:!1,registered:e.registered,state:m,onRegisterClick:e.onRegisterClick,children:p.jsx(k,{onRetryClick:h,webauthnTouchState:A})})};export{Z as default};
