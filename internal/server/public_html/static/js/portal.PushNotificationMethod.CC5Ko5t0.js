import{u as A,m as B,r as c,g as U,h as M,A as b,j as u,B as j}from"./index.Cnoc1xvA.js";import{F as H}from"./components.FailureIcon.CJF-1aOx.js";import{P as O}from"./components.PushNotificationIcon.BscBAMBE.js";import{S as Y}from"./components.SuccessIcon.DhmnFkmE.js";import{j as q,B as G}from"./constants.constants.C7XWv2Yg.js";import{u as Q}from"./hooks.Mounted.zqJHXAmG.js";import{u as $}from"./hooks.OpenIDConnect.DIXavwCS.js";import{i as z,c as J,a as K,D as V}from"./portal.DeviceSelectionContainer.Dp66m6Mw.js";import{D as W,S}from"./portal.MethodContainer.BjdCDRHJ.js";import"./components.InformationIcon.DesXiPIb.js";import"./portal.Authenticated.DmyQJIWb.js";var X=(e=>(e[e.SignInInProgress=1]="SignInInProgress",e[e.Success=2]="Success",e[e.Failure=3]="Failure",e[e.Selection=4]="Selection",e[e.Enroll=5]="Enroll",e[e.RateLimited=6]="RateLimited",e))(X||{});const de=function(e){const{t:n}=A(),{classes:N}=Z(),{id:y,flow:g,subflow:T}=q(),k=$(),[a,t]=c.useState(1),R=U(M),s=Q(),[I,x]=c.useState(""),[P,C]=c.useState([]),{onSignInSuccess:E,onSignInError:w}=e,i=c.useRef(w),m=c.useRef(E),l=c.useRef(null),o=c.useRef(null);c.useEffect(()=>{i.current=w},[w]),c.useEffect(()=>{m.current=E},[E]),c.useEffect(()=>()=>{l.current!==null&&(clearTimeout(l.current),l.current=null),o.current!==null&&(clearTimeout(o.current),o.current=null)},[]);const L=c.useCallback(r=>{l.current&&clearTimeout(l.current),t(6),i.current(new Error(n("You have made too many requests"))),l.current=setTimeout(()=>{if(!s.current){l.current=null;return}t(3),l.current=null},r*1e3)},[s,i,n]),_=c.useCallback(async()=>{try{const r=await z();if(!s.current)return;switch(r.result){case"auth":let d=[];r.devices.forEach(f=>d.push({id:f.device,name:f.display_name,methods:f.capabilities})),C(d),t(4);break;case"allow":i.current(new Error(n("Device selection was bypassed by Duo policy"))),t(2);break;case"deny":i.current(new Error(n("Device selection was denied by Duo policy"))),t(3);break;case"enroll":i.current(new Error(n("No compatible device found"))),r.enroll_url&&e.duoSelfEnrollment&&x(r.enroll_url),t(5);break}}catch(r){if(!s.current)return;console.error(r),i.current(new Error(n("There was an issue fetching Duo device(s)")))}},[e.duoSelfEnrollment,s,i,n]),v=c.useCallback(async()=>{if(e.authenticationLevel!==b.TwoFactor)try{t(1);const r=await J(R,y,g,T,k);if(!s.current)return;if(r)if(r.data&&!r.limited)switch(r.data.result){case"auth":let d=[];r.data.devices.forEach(f=>d.push({id:f.device,name:f.display_name,methods:f.capabilities})),C(d),t(4);break;case"enroll":i.current(new Error(n("No compatible device found"))),r.data.enroll_url&&e.duoSelfEnrollment&&x(r.data.enroll_url),t(5);break;case"deny":i.current(new Error(n("Device selection was denied by Duo policy"))),t(3);break;default:t(2),o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{s.current&&(o.current=null,m.current(r.data?r.data.redirect:void 0))},1500)}else r.limited?L(r.retryAfter):(t(2),o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{s.current&&(o.current=null,m.current(r.data?r.data.redirect:void 0))},1500));else i.current(new Error(n("There was an issue completing sign in process"))),t(3)}catch(r){if(!s.current||a!==1)return;console.error(r),i.current(new Error(n("There was an issue completing sign in process"))),t(3)}},[e.authenticationLevel,e.duoSelfEnrollment,R,y,g,T,k,s,i,n,m,L,a]),p=c.useCallback(async function(r){try{await K(r),e.registered?t(1):(t(1),e.onSelectionClick())}catch(d){console.error(d),i.current(new Error(n("There was an issue updating preferred Duo device")))}},[i,e,n]),F=c.useCallback(r=>{p({device:r.id,method:r.method})},[p]);if(c.useEffect(()=>{e.authenticationLevel>=b.TwoFactor&&t(2)},[e.authenticationLevel,t]),c.useEffect(()=>{a===1&&v()},[v,a]),a===4)return u.jsx(V,{devices:P,onBack:()=>t(1),onSelect:F});let h;switch(a){case 1:h=u.jsx(O,{width:64,height:64,animated:!0});break;case 2:h=u.jsx(Y,{});break;case 3:h=u.jsx(H,{})}let D=S.METHOD;return e.authenticationLevel===b.TwoFactor?D=S.ALREADY_AUTHENTICATED:a===5&&(D=S.NOT_REGISTERED),u.jsxs(W,{id:e.id,title:n("Push Notification"),explanation:n("A notification has been sent to your smartphone"),duoSelfEnrollment:I?e.duoSelfEnrollment:!1,registered:e.registered,state:D,onSelectClick:_,onRegisterClick:()=>window.open(I,"_blank"),children:[u.jsx(j,{className:N.icon,children:h}),u.jsx(j,{className:a!==3?"hidden":"",children:u.jsx(G,{color:"secondary",onClick:v,children:n("Retry")})})]})},Z=B()(e=>({icon:{width:"64px",height:"64px",display:"inline-block"}}));export{X as State,de as default};
