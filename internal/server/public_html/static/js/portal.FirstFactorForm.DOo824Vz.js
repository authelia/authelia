import{j as t,U as ae,u as B,g as L,h as W,aB as N,r as s,G as u,T as ie,q as Z,m as ce,p as le,c as ue,aC as de,aD as fe,t as he,ak as me,aE as we}from"./index.Cnoc1xvA.js";import{I as ge,V as xe,a as be,A as ye}from"./mui.VisibilityOff.BYifsFCs.js";import{j as G,a as pe,B as H,h as Se}from"./constants.constants.C7XWv2Yg.js";import{u as O}from"./hooks.Mounted.zqJHXAmG.js";import{u as ke}from"./hooks.OpenIDConnect.DIXavwCS.js";import{L as Ce}from"./layouts.Login.D4WgGmD_.js";import{p as je,I as Re}from"./services.Password.C1zV6RUO.js";import{c as ve,e as Ae,h as Ee,i as Pe,p as Te}from"./services.WebAuthn.ssE5ERIK.js";import{B as Le,C as Me}from"./broadcast-channel.DDE4QoSq.js";import{F as qe,T as K}from"./mui.TextField.DV7iCphh.js";import{F as Fe}from"./mui.FormControlLabel.Des70i-0.js";import"./layouts.usePortalStyles.B9PXrA8Z.js";import"./browserSupportsWebAuthn.Bhlk1eaM.js";const Ie=function(){return t.jsx(ae,{children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",height:24,width:24,viewBox:"0 -960 960 960",fill:"#e8eaed",children:t.jsx("path",{d:"M120-160v-112q0-34 17.5-62.5T184-378q62-31 126-46.5T440-440q20 0 40 1.5t40 4.5q-4 58 21 109.5t73 84.5v80H120ZM760-40l-60-60v-186q-44-13-72-49.5T600-420q0-58 41-99t99-41q58 0 99 41t41 99q0 45-25.5 80T790-290l50 50-60 60 60 60-80 80ZM440-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm300 80q17 0 28.5-11.5T780-440q0-17-11.5-28.5T740-480q-17 0-28.5 11.5T700-440q0 17 11.5 28.5T740-400Z"})})})},De=function(e){const{t:r}=B(),d=L(W),C=L(N),{id:v,flow:b,subflow:j}=G(),i=O(),[y,R]=s.useState(!1),l=s.useRef(e.onAuthenticationError),m=s.useRef(e.onAuthenticationSuccess);s.useEffect(()=>{l.current=e.onAuthenticationError},[e.onAuthenticationError]),s.useEffect(()=>{m.current=e.onAuthenticationSuccess},[e.onAuthenticationSuccess]);const p=s.useCallback(()=>{e.onAuthenticationStart(),R(!0)},[e]),c=s.useCallback(()=>{e.onAuthenticationStop(),R(!1)},[e]),S=s.useCallback(async()=>{if(!(!i.current||y)){p();try{const w=await ve();if(w.status!==200||w.options==null){if(!i.current)return;c(),l.current(new Error(r("Failed to initiate security key sign in process")));return}const o=await Ae(w.options);if(o.result!==Ee.Success){if(!i.current)return;c(),l.current(new Error(r(Pe(o.result))));return}if(o.response==null){if(!i.current)return;l.current(new Error(r("The browser did not respond with the expected attestation data"))),c();return}if(!i.current)return;const g=await Te(o.response,e.rememberMe,d,C,v,b,j);if(!i.current)return;if(c(),g.data.status==="OK"&&g.status===200){m.current(g.data.data?g.data.data.redirect:void 0);return}if(!i.current)return;l.current(new Error(r("The server rejected the security key")))}catch(w){if(!i.current)return;c(),console.error(w),l.current(new Error(r("Failed to initiate security key sign in process")))}}},[i,y,p,e,d,C,v,b,j,c,l,m,r]);return t.jsxs(s.Fragment,{children:[t.jsx(u,{size:{xs:12},children:t.jsx(pe,{component:"div",role:"presentation",children:t.jsx(ie,{sx:{textTransform:"uppercase"},children:r("or")})})}),t.jsx(u,{size:{xs:12},children:t.jsx(H,{id:"passkey-sign-in-button",variant:"contained",color:"primary",fullWidth:!0,onClick:S,startIcon:t.jsx(Ie,{}),disabled:e.disabled,endIcon:y?t.jsx(Z,{size:20}):null,children:r("Sign in with a passkey")})})]})},Ye=function(e){const{t:r}=B(),{classes:d,cx:C}=Ue(),v=le(),b=L(W),j=L(N),{id:i,flow:y,subflow:R}=G(),l=ke(),{createErrorNotification:m}=ue(),p=O(),c=s.useMemo(()=>new Le("login"),[]),[S,w]=s.useState(!1),[o,g]=s.useState(""),[V,A]=s.useState(!1),[a,M]=s.useState(""),[F,f]=s.useState(!1),[Q,I]=s.useState(!1),[X,D]=s.useState(!1),[J,U]=s.useState(!1),[Y,q]=s.useState(!1),E=s.useRef(null),P=s.useRef(null),k=s.useCallback(()=>{E.current!==null&&E.current.focus()},[E]),h=s.useCallback(()=>{P.current!==null&&P.current.focus()},[P]);s.useEffect(()=>{const n=setTimeout(()=>k(),10);return()=>clearTimeout(n)},[k]),s.useEffect(()=>{c.addEventListener("message",n=>{n&&e.onChannelStateChange()})},[c,b,e]);const T=e.disabled,_=de(),$=fe(),ee=()=>{w(!S)},x=s.useCallback(async()=>{if(o===""||a===""){o===""&&A(!0),a===""&&U(!0);return}q(!0),e.onAuthenticationStart();try{const n=await je(o,a,S,b,j,i,y,R,l);if(!p.current)return;q(!1),await c.postMessage(!0),e.onAuthenticationSuccess(n?n.redirect:void 0)}catch(n){if(console.error(n),!p.current)return;m(r("Incorrect username or password")),q(!1),e.onAuthenticationStop(),M(""),h()}},[o,a,e,S,b,j,i,y,R,l,c,m,r,h,p]),te=()=>{e.resetPassword&&(e.resetPasswordCustomURL!==""?window.open(e.resetPasswordCustomURL):v(we))},se=s.useCallback(n=>{n.key==="Enter"&&(o.length?o.length&&a.length?x().catch(console.error):(A(!1),h()):A(!0))},[h,x,a.length,o.length]),ne=s.useCallback(n=>{n.key==="Enter"&&(o.length?a.length||h():k(),x().catch(console.error),n.preventDefault())},[h,k,x,a.length,o.length]),re=s.useCallback(n=>{if(a.length<=1&&(I(!1),D(!1),a.length===0))return;const z=Re(n);z!==null&&(z?I(!0):D(!0))},[a.length]),oe=s.useCallback(n=>{n.key==="Enter"&&(o.length?a.length||h():k(),x().catch(console.error))},[h,k,x,a.length,o.length]);return t.jsx(Ce,{id:"first-factor-stage",title:_,subtitle:$,children:t.jsx(qe,{id:"form-login",children:t.jsxs(u,{container:!0,spacing:2,children:[t.jsx(u,{size:{xs:12},children:t.jsx(K,{inputRef:E,id:"username-textfield",label:r("Username"),variant:"outlined",required:!0,value:o,error:V,disabled:T,fullWidth:!0,onChange:n=>g(n.target.value),onFocus:()=>A(!1),autoCapitalize:"none",autoComplete:"username",onKeyDown:se})}),t.jsx(u,{size:{xs:12},children:t.jsx(K,{inputRef:P,id:"password-textfield",label:r("Password"),variant:"outlined",required:!0,fullWidth:!0,disabled:T,value:a,error:J,onChange:n=>M(n.target.value),onFocus:()=>U(!1),type:F?"text":"password",autoComplete:"current-password",onKeyDown:ne,onKeyUp:re,slotProps:{input:{endAdornment:t.jsx(ge,{position:"end",children:t.jsx(he,{"aria-label":"toggle password visibility",edge:"end",size:"large",onMouseDown:()=>f(!0),onMouseUp:()=>f(!1),onMouseLeave:()=>f(!1),onTouchStart:()=>f(!0),onTouchEnd:()=>f(!1),onTouchCancel:()=>f(!1),onKeyDown:n=>{n.key===" "&&(f(!0),n.preventDefault())},onKeyUp:n=>{n.key===" "&&(f(!1),n.preventDefault())},children:F?t.jsx(xe,{}):t.jsx(be,{})})})}}})}),Q?t.jsx(u,{size:{xs:12},marginX:2,children:t.jsxs(me,{severity:"warning",children:[t.jsx(ye,{children:r("Warning")}),r(X?"The password was partially entered with Caps Lock":"The password was entered with Caps Lock")]})}):null,e.rememberMe?t.jsx(u,{size:{xs:12},className:C(d.actionRow),children:t.jsx(Fe,{control:t.jsx(Me,{id:"remember-checkbox",disabled:T,checked:S,onChange:ee,onKeyDown:oe,value:"rememberMe",color:"primary"}),className:d.rememberMe,label:r("Remember me")})}):null,t.jsx(u,{size:{xs:12},children:t.jsx(H,{id:"sign-in-button",variant:"contained",color:"primary",fullWidth:!0,endIcon:Y?t.jsx(Z,{size:20}):null,disabled:T,onClick:x,children:r("Sign in")})}),e.passkeyLogin?t.jsx(De,{disabled:e.disabled,rememberMe:e.rememberMe,onAuthenticationError:n=>m(n.message),onAuthenticationStart:()=>{g(""),M(""),e.onAuthenticationStart()},onAuthenticationStop:e.onAuthenticationStop,onAuthenticationSuccess:e.onAuthenticationSuccess}):null,e.resetPassword?t.jsx(u,{size:{xs:12},className:C(d.actionRow,d.flexEnd),children:t.jsx(Se,{id:"reset-password-button",component:"button",onClick:te,className:d.resetLink,underline:"hover",children:r("Reset password?")})}):null]})})})},Ue=ce()(e=>({actionRow:{display:"flex",flexDirection:"row",marginTop:e.spacing(-1),marginBottom:e.spacing(-1)},resetLink:{cursor:"pointer",paddingTop:13.5,paddingBottom:13.5},rememberMe:{flexGrow:1},flexEnd:{justifyContent:"flex-end"}}));export{Ye as default};
