import{u as b,g as k,h as I,r as a,A as R,j as T}from"./index.ChPl_EQa.js";import{W as F}from"./WebAuthnTryIcon.xUbCgyOi.js";import{j as C}from"./constants.BMlb_xNc.js";import{u as W}from"./Mounted.BDD2csTQ.js";import{u as x}from"./OpenIDConnect.DNND1xJL.js";import{W as r,j,e as D,h as L,i as v,k as M}from"./WebAuthn.Bl8o_9tA.js";import{D as O,S as f}from"./MethodContainer.CoUER_Eo.js";import"./FailureIcon.CxGqcw_S.js";import"./SuccessIcon.B9a1SrTu.js";import"./TimerIcon.B7oHXPOi.js";import"./Timer.R1JhW7SA.js";import"./IconWithContext.De5e-2-q.js";import"./browserSupportsWebAuthn.Bhlk1eaM.js";import"./InformationIcon.PYGiftKG.js";import"./Authenticated.xuh53C9_.js";const Z=function(e){const{t}=b(),h=k(I),{id:m,flow:S,subflow:g}=C(),E=x(),o=W(),[y,n]=a.useState(r.WaitTouch),{onSignInSuccess:p,onSignInError:A}=e,s=a.useRef(A).current,w=a.useRef(p).current,l=a.useCallback(async()=>{if(!(!e.registered||e.authenticationLevel===R.TwoFactor))try{n(r.WaitTouch);const i=await j();if(i.status!==200||i.options==null){n(r.Failure),s(new Error(t("Failed to initiate security key sign in process")));return}const u=await D(i.options);if(u.result!==L.Success){if(!o.current)return;n(r.Failure),s(new Error(t(v(u.result))));return}if(u.response==null){s(new Error(t("The browser did not respond with the expected attestation data"))),n(r.Failure);return}if(!o.current)return;n(r.InProgress);const c=await M(u.response,h,m,S,g,E);if(c.data.status==="OK"&&c.status===200){w(c.data.data?c.data.data.redirect:void 0);return}if(!o.current)return;s(new Error(t("The server rejected the security key"))),n(r.Failure)}catch(i){if(!o.current)return;console.error(i),s(new Error(t("Failed to initiate security key sign in process"))),n(r.Failure)}},[e.registered,e.authenticationLevel,o,h,m,S,g,E,s,t,w]);a.useEffect(()=>{l().catch(console.error)},[l]);let d=f.METHOD;return e.authenticationLevel===R.TwoFactor?d=f.ALREADY_AUTHENTICATED:e.registered||(d=f.NOT_REGISTERED),T.jsx(O,{id:e.id,title:t("Security Key"),explanation:t("Touch the token of your security key"),duoSelfEnrollment:!1,registered:e.registered,state:d,onRegisterClick:e.onRegisterClick,children:T.jsx(F,{onRetryClick:l,webauthnTouchState:y})})};export{Z as default};
